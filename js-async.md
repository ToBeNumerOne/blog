# javascript异步机制

----
> 一道由setTimeout面试题引发的javascript异步机制的思考与说明。

## 一、前言

最近翻看博客以及参与公司的一些面试，发现一个面试题非常有意思，并且此面试题目有80%的面试者回答不出正确答案。为此，笔者借此次项目组月报，与各位读者分享下此题的解题思路以及javascript的异步机制。

## 二、setTimeout面试题

究竟是哪道面试题，让笔者觉得能够非常体现出面试者的基础水平以及非常有必要在本文讲解下javascript的异步机制？话不多说，请大家直接看下面的代码：


```javascript
console.log(-1);

for (var i = 0; i < 5; i++) {
    setTimeout(function() {
        console.log(i);
    }, 0);
}

console.log(5);
```

读者自己可以先看下这道题目，然后自己写一下这段javascript程序的输出结果。如果把setTimeout函数中的时间间隔设置成1000ms，同时用>表示两次输出之间有大于等于1000ms的时间间隔，用／表示两次输出的时间间隔可以忽略不计，那么上述问题的结果又该是如何？

笔者在参与面试的时候，发现面试者们的答案千奇百怪，针对第一问，有答-1,0,1,2,3,4,5的，也有回答-1,5,0,1,2,3,4的。这些都是错误答案，那么现在先公布下正确答案：

> setTimeout时间间隔为0时，答案是-1,5,5,5,5,5,5
> 
> setTimeout时间间隔为1000时，答案时－1/5>5/5/5/5/5

各位读者可以自行验证下，至于为什么会输出这种答案，这里先卖个关子，请读者先带着这个问题继续阅读下面的内容。

## 三、javascript异步详解

### 1、javascript是单线程的

在学习javascript异步机制之前，我们必须先知道以及熟记**javascript是事件驱动单线程的语言**这句话。这句话怎么理解呢？我们可以认为我们所编写的javascript代码都是通过javascript引擎来执行。javascript引擎的工作模式是单线程的，即一个任务结束才继续执行下一个任务。既然这种执行模式非常符合人类的思维方式，代码编写起来也十分方便，那么javascript还是要设计异步呢？试想一下如下场景：

我们利用javascript向远程服务器请求数据。假设网络信号非常差，javascript引擎一直没有等到远程服务器的返回结果。如果按照上述没有异步的模式来执行代码，那么下一个任务只能无奈的等啊等。又比如操作文件，文件非常大，如果没有异步的方式，javascript引擎必须等到文件操作完成之后才能执行下一段javascript代码，这些情况就会导致页面出现严重卡顿的现象。对于这种现象，无论如何是不允许的。所以针对上述情况等，就设计了javascript引擎异步的执行代码。

### 2、浏览器是多线程的

我们知道了javascript是单线程的以及为什么要设计javascript的异步执行之后，为了更好的了解javascript的异步，我们先对多线程的浏览器做个简单的了解。首先浏览器是多线程的，这点我想大家都了解。对于任何一个多线程的现代浏览器，必定会至少常驻三个线程，它们分别是：javascript引擎线程、GUI渲染线程、事件线程。其它的线程还有网络请求线程、定时器线程等。

javascript引擎线程是以单线程的方式执行javascript代码，也就是说一个任务结束之后再执行之后的任务。

### 3、何为异步

在javascript中，所谓异步，指的就是javascript引擎会优先执行同步的代码片段（按照javascript代码的书写顺序），执行完同步代码之后，最后执行异步操作结果的代码片段。其实，javascript的异步也可以说是基于事件的异步（因为javascript本身就是一门基于事件驱动的语言）。

何为异步操作？常见的异步操作大致有如下三种情况：

* IO操作
* 网络请求
* setTimeout以及setInterval

经过上述啰嗦的铺垫，我们现在正式的介绍javascript中的异步。所谓的异步指的就是javascript引擎线程在执行任务的时候，***会把所有的javascript代码当作同步任务来执行***，如果遇到上述异步任务，则调用相应的浏览器线程执行异步代码。

同时，又由于javascript是一门事件驱动的语言，所以在执行异步任务的同时，会将与此异步任务所绑定的代码块注册到一个任务队列中。既然队列，那么顾名思义，即该任务队列是先进先出的结构。

也就是说javascript引擎线程会先正常执行同步代码，执行同步代码结束之后（javascript引擎空闲下来），会查看任务队列是否有待执行的任务，如果有的话，按照队列的先进先出顺序，依次执行任务队列中的任务。

### 4、上述面试题详解

读到这里，相信读者对于javascript的异步机制已经有了一定的了解。但是理论始终是空洞的，有可能由于笔者拙略的文笔，使得您对于javascript的异步理解起来反而更加吃力。不要慌，我们现在结合上述面试题，来详细了解下javascript的异步机制。

上述面试题代码的运行步骤大致如下：

* 首先javascript引擎线程执行第一条语句，输出－1；
* 其次javascript执行for循环代码块，分别注册5个定时器；定时器等待0ms，所以会立即注册setTimeout的结果代码。**注意此处是立即注册，不是立即执行**
* javascript引擎线程执行最后一条语句，输出5；
* javascript引擎线程执行完同步代码，处于空闲状态。会自动查看任务队列，发现任务队列有待执行的任务，所以javascript引擎线程立即**按照先入先出的顺序**执行这些任务。从而输出结果是-1,5,5,5,5,5,5。此处setTimeout之所以输出5，那是因为在同步代码执行结束之后，执行注册在任务队列中setTimeout的事件代码的时候变量i的值经过循环已经变成5。
* 如果设置时间间隔为1000ms的时候，javascript引擎线程也是会立即执行setTimeout函数，即马上启动setTimeout的异步线程，**并且开始计时**。只不过是在1000ms之后向任务队列注册代码，由于for循环代码执行的时间间隔较短，几乎不怎么耗时，所以导致5个setTimeout函数在1000ms之后向任务队列注册代码时候，可以说是没有时间间隔，几乎是按照先后顺序同时注册。所以导致最终的输出结果是－1/5>5/5/5/5/5。

其它的异步场景和setTimeout类似，大家可以使用上述思想来理解IO操作以及网络请求的场景。本文除了主要介绍javascript的异步机制以外，还想要纠正的一个关于定时器的概念：

> **setTimeout、setInterval函数指的是在一定的时间间隔之后，向任务队列注册任务（即javascript代码），javascript引擎线程对待它们和其它同步代码是一样的，也就是说javascript引擎线程遇到他会马上执行，即马上开始计时。到达定时器时间间隔之后，马上向任务队列注册任务**


## 四、谨慎使用定时器

经过上述介绍，相信大家对于javascript异步机制以及setTimeout、setInterval有了一定的了解。但是笔者还想再啰嗦几句关于定时器的使用。使用setTimeout时候，设置延迟时间之后执行代码，如1000ms，那么在实际过程中可能过了大于1000ms才会执行setTimeout函数中的代码。比如在setTimeout开始计时之后，javascript执行了一段耗时5000ms的代码（for循环），那么根据上述所讲，setTimeout事件代码必须等到javascript引擎空闲才会执行任务队列的代码，这样代码的延迟就大于1000ms。

同理，对于setInterval，它所代表的是每隔一段规定时间，动态的向任务队列中注册代码块，这个没有毛病，但是如果该代码块执行时间过长，那么代码块之间的时间间隔就会小于置顶的延迟时间。

同时，关于设置延迟时间的最小值，网上都有说明，请各位读者自行百度。

## 五、结语

其实关于上述面试题，还可以延伸下，比如需要setTimeout代码块输出0，1，2，3，4应该如何改进上述代码。本文在此就不一一说明了，请大家自行百度，网上有很多解决办法。

如果读者觉得本文有讲解不对的地方，欢迎拍砖指正，谢谢大家！

## Refrence
本文面试题部分的介绍参考王大师（@王仕军）的[80% 应聘者都不及格的 JS 面试题](https://juejin.im/post/58cf180b0ce4630057d6727c)
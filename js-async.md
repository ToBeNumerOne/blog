# javascript异步机制

----
> 本文主要讲解js中的异步机制。

## 一、前言

最近翻看博客以及参与公司的一些面试，发现一个面试题非常有意思，并且此面试题目有80%的面试者回答不出正确答案。为此，笔者借此次项目组月报，与各位读者分享下此题的解题思路以及js的异步机制。

## 二、setTimeout面试题

究竟是哪道面试题，让笔者觉得能够非常体现出面试者的基础水平以及非常有必要在本文讲解下js的异步机制？话不多说，请大家直接看下面的代码：


```javascript
console.log(-1);

for (var i = 0; i < 5; i++) {
    setTimeout(function() {
        console.log(i);
    }, 0);
}

console.log(5);
```

读者自己可以先看下这道题目，然后自己写一下这段js程序的输出结果。如果把setTimeout函数中的时间间隔设置成1000ms，同时用>表示两次输出之间有大于等于1000ms的时间间隔，用／表示两次输出的时间间隔可以忽略不计，那么上述问题的结果又该是如何？

现在公布正确答案：

> setTimeout时间间隔为0时，答案是-1,5,5,5,5,5,5
> 
> setTimeout时间间隔为1000时，答案时－1/5>5/5/5/5/5

各位读者可以自行验证下，具体为甚么会输出这种答案，我会在下面的模块中讲述。

## 三、js异步详解

### 1、js是单线程的

在学习js异步机制之前，我们必须先知道以及熟记**js是单线程的语言**这句话。单线程代表着js引擎是一段接一段的执行js代码，即js引擎是以同步的形式来执行js代码。那么为什么还会需要异步呢？试想一下如下场景：

我们利用js操作文件，文件非常大，如果是以同步的方式，js引擎必须等到文件操作完成之后才能其它js代码，这样会导致出现卡顿等现象。对于这种现象，无论如何是不允许的。同样的道理，在我们进行网络请求的时候，也不允许出现这种情况。所以针对上述情况等，就设计了js引擎异步的执行代码。

### 2、浏览器是多线程的

我们知道了js是单线程的以及为什么要设计js的异步执行之后，为了更好的了解js的异步，我们先对多线程的浏览器做个简单的了解。首先浏览器是多线程的，这点我想大家都了解。对于任何一个多线程的浏览器，必定会至少常驻三个线程，它们分别是：js引擎线程、GUI渲染线程、事件线程。其它的线程还有网络请求线程、定时器线程等。

js引擎线程是单线程执行js代码的，也就是说一个任务结束之后再执行之后的任务。

### 3、何为异步

在javascript中，所谓异步，指的就是js引擎会优先执行同步的代码片段（按照js代码的书写顺序），执行完同步代码之后，最后执行异步操作结果的代码片段。其实，js的异步也可以说是基于事件的异步。

何为异步操作？常见的异步操作有如下三种情况：

* IO操作
* 网络请求
* setTimeout以及setInterval

经过上述啰嗦的铺垫，我们现在正式的介绍js中的异步。所谓的异步指的就是js引擎线程在执行任务的时候，会把所有的js代码当作同步任务来执行，如果遇到上述异步任务，则调用相应的浏览器线程执行异步代码。

同时，又由于javascript是一门事件驱动的语言，所以在执行异步任务的同时，会将与此异步任务所绑定的代码块注册到一个任务队列中。既然队列，那么顾名思义，即该事件队列是先进先出的结构。

也就是说js引擎线程会先正常执行同步代码，执行结束之后，会查看任务队列是否有待执行的任务，如果有的话，按照队列的先进先出顺序，依次执行任务队列中的任务。

### 4、上述面试题详解

读到这里，相信读者对于js的异步机制已经有了一定的了解。但是理论始终是空洞的，有可能由于笔者拙略的文笔，使得您对于异步理解起来反而更加吃力。不要慌，我们现在结合上述面试题，来详细了解下javascript的异步机制。

* js引擎线程执行第一条语句，输出－1；
* 其次js执行for循环代码块，分别注册5个定时器；定时器等待0ms，所以会立即注册setTimeout的结果代码。**注意此处是立即注册，不是立即执行**
* js引擎线程执行最后一条语句，输出5；
* js引擎线程执行完同步代码，处于空闲状态。会自动查看任务队列，发现任务队列有待执行的任务，所以js引擎线程立即**按照先入先出的顺序**执行这些任务。从而输出结果是-1,5,5,5,5,5,5
* 如果设置时间间隔为1000ms的时候，js引擎线程也是会立即执行setTimeout函数，只不过是在1000ms之后向任务队列注册代码，由于时间间隔较短，并且同步代码几乎不怎么耗时，所以导致setTimeout函数在向任务队列注册代码时候，几乎没有时间间隔。所以导致最终的输出结果是－1/5>5/5/5/5/5

其它的异步场景和setTimeout类似，大家可以使用上述思想来理解IO操作以及网络请求的场景。本文除了主要介绍javascript的异步机制以外，还想要纠正的一个概念就是：

> **setTimeout、setInterval函数指的是在一定的时间间隔之后，向任务队列注册任务（即js代码），javascript引擎线程对待它和其它同步代码是一样的，也就是说javascript引擎线程遇到他会马上执行，即马上开始计时。到达定时器时间间隔之后，马上向任务队列注册任务**

## 四、结语

如果读者觉得本文有讲解不对的地方，欢迎拍砖指正，谢谢大家！






